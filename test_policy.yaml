# test_policy.yaml
#
#  uv edge-monitor-run --config test_policy.yaml

# --- Global Variables ---
# Define your constants here. They will be injected into the settings below.
variables:
  day_start: 6        # 06:00 AM
  night_start: 22     # 10:00 PM
  day_limit: 60.0     # Decibel limit for Day
  night_limit: 50.0   # Decibel limit for Night

  # Hardware Calibration
  calibration_file_path: "src/umik-1/7175488.txt"
  # Override this on your Pi to point to USB drive if needed
  # output_path: "/mnt/usb_storage/recordings" 

# --- Hardware Configuration ---
hardware:
  calibration_file: "{calibration_file_path}"

# --- System Services Configuration ---
services:
  internet_enabled: true
  
  # Control Variable for Storage
  recording_output_path: "recordings" 
  
  # Health Monitoring
  heartbeat_interval_seconds: 60
  gpio_heartbeat_pin: 17
  hc_ping_url: "{HC_PING_URL}"

  # Cloud & Notifications
  telegram_enabled: true
  cloud_storage_enabled: true
  retry_attempts: 3
  retry_delay_seconds: 5
  alert_cooldown_seconds: 60

  # These values are injected from the variables block above
  day_start_hour: "{day_start}"
  night_start_hour: "{night_start}"
  
  # Cloud Provider Settings
  cloud:
    provider: "magalu"
    bucket_name: "acoustic-logs"

# --- AI Model Configuration ---
feature_extractor:
  use_tflite: false 

  sad_threshold_rms: 0.002
  sad_threshold_flux: 5.0
  sad_threshold_dbspl: 45.0

# --- Reporting & Analysis Configuration ---
reporting:
  days_to_report: 30
  
  limits:
    day_db: "{day_limit}"
    night_db: "{night_limit}"
  
  category_mapping:
    "intruder_alert": "Security"
    "help_shout": "Security"
    "glass_break_verified": "Security"
    "Speech": "Vocals"
    "Narration": "Vocals"
    "Music": "Nuisance"
    "Musical_instrument": "Nuisance"
    "Domestic_animals": "Nature"

# --- 4. Test Policies ---
policies:
  # 1. TEST RECORDING & UPLOAD (Trigger: Clap your hands)
  # This tests:
  #   - Pre-roll buffering (did it catch the start of the clap?)
  #   - WAV file creation
  #   - S3/Magalu Upload
  - name: "TEST: Cloud Upload Chain"
    description: "Clap hands to test full recording and upload pipeline."
    # Clapping is usually Class 60. Confidence > 0.4 filters out noise.
    condition: "current_event_label == 'Clapping' and current_confidence > 0.4"
    actions: 
      - "record_evidence"  # Creates the WAV
      - "cloud_upload"     # Sends to Magalu/S3
    ignore_privacy: true

  # 2. TEST TELEGRAM (Trigger: Speak/Shout)
  # This tests:
  #   - Bot connectivity
  #   - Message formatting (check if dBSPL appears in the msg)
  #   - Retry logic (if you disconnect wifi briefly)
  - name: "TEST: Telegram Alert"
    description: "Speak loudly to test Telegram notification."
    # 'Speech' or 'Narration' are common YAMNet classes for talking.
    condition: "current_event_label in ['Speech', 'Narration'] and current_confidence > 0.6"
    actions: 
      - "telegram_alert"
      - "log_metadata"    # Verifies the event was seen in local logs
    ignore_privacy: true

  # 3. TEST PHYSICS / CALIBRATION (Trigger: Snap fingers close to mic)
  # This tests:
  #   - Spectral Flux (Sudden changes)
  #   - dBSPL thresholds
  - name: "TEST: Physics Trigger"
    description: "Snap fingers to test pure physics triggers (no AI dependency)."
    # Flux > 10 captures sharp transients like snaps/knocks.
    # dBSPL > 60 ensures it's not background noise.
    condition: "metrics['flux'] > 10.0 or metrics['dbspl'] > 60.0"
    actions: 
      - "log_metadata"
    ignore_privacy: true